#' Expectation: does string/output/message/warning/error match a regular expression?
#'
#' @inheritParams expect_that
#' @param regexp regular expression to test against. If omitted,
#'   just asserts that code produces some output, messsage, warning or
#'   error. Alternatively, you can specify \code{NA} to indicate that
#'   there should be no output, messages, warnings or errors.
#' @param all should all elements of actual value match \code{regexp} (TRUE),
#'    or does only one need to match (FALSE)
#' @param ... Additional arguments passed on to \code{\link{grepl}}, e.g.
#'   \code{ignore.case} or \code{fixed}.
#' @family expectations
#' @param class expected class of error condition. This can be use to test
#' that functions produce customized error conditions of the appropriate class.
#' @examples
#' expect_match("Testing is fun", "fun")
#' expect_match("Testing is fun", "f.n")
#'
#' # Output --------------------------------------------------------------------
#' str(mtcars)
#' expect_output(str(mtcars), "32 obs")
#' expect_output(str(mtcars), "11 variables")
#'
#' # You can use the arguments of grepl to control the matching
#' expect_output(str(mtcars), "11 VARIABLES", ignore.case = TRUE)
#' expect_output(str(mtcars), "$ mpg", fixed = TRUE)
#'
#' # Messages ------------------------------------------------------------------
#'
#' f <- function(x) {
#'   if (x < 0) message("*x* is already negative")
#'   -x
#' }
#' expect_message(f(-1))
#' expect_message(f(-1), "already negative")
#' expect_message(f(1), NA)
#'
#' # You can use the arguments of grepl to control the matching
#' expect_message(f(-1), "*x*", fixed = TRUE)
#' expect_message(f(-1), "NEGATIVE", ignore.case = TRUE)
#'
#' # Warnings --------------------------------------------------------------------
#' f <- function(x) {
#'   if (x < 0) warning("*x* is already negative")
#'   -x
#' }
#' expect_warning(f(-1))
#' expect_warning(f(-1), "already negative")
#' expect_warning(f(1), NA)
#'
#' # You can use the arguments of grepl to control the matching
#' expect_warning(f(-1), "*x*", fixed = TRUE)
#' expect_warning(f(-1), "NEGATIVE", ignore.case = TRUE)
#'
#'
#' # Errors --------------------------------------------------------------------
#' f <- function() stop("My error!")
#' expect_error(f())
#' expect_error(f(), "My error!")
#'
#' # You can use the arguments of grepl to control the matching
#' expect_error(f(), "my error!", ignore.case = TRUE)
#'
#' @name matching-expectations
NULL

#' @export
#' @rdname matching-expectations
expect_match <- function(object, regexp, ..., all = TRUE, info = NULL, label = NULL) {
  if (is.null(label)) {
    label <- find_expr("object")
  }
  expect_that(object, matches(regexp, all = all, ...), info = info, label = label)
}

#' @export
#' @rdname oldskool
matches <- function(regexp, all = TRUE, ...) {
  stopifnot(is.character(regexp), length(regexp) == 1)
  function(char) {
    matches <- grepl(regexp, char, ...)
    if (length(char) > 1) {
      values <- paste0("Actual values:\n",
        paste0("* ", encodeString(char), collapse = "\n"))
    } else {
      values <- paste0("Actual value: \"", encodeString(char), "\"")
    }

    expectation(
      length(matches) > 0 && if (all) all(matches) else any(matches),
      paste0("does not match '", encodeString(regexp), "'. ", values),
      paste0("matches '", encodeString(regexp), "'")
    )
  }
}

#' @export
#' @rdname matching-expectations
expect_output <- function(object, regexp, ..., info = NULL, label = NULL) {
  if (is.null(label)) {
    label <- find_expr("object")
  }
  expect_that(object, prints_text(regexp, ...), info = info, label = label)
}
#' @export
#' @rdname oldskool
prints_text <- function(regexp, ...) {
  function(expr) {
    output <- evaluate_promise(expr, print = TRUE)$output

    if (identical(regexp, NA)) {
      return(expectation(
        !is.null(output),
        paste0("produced output: ", encodeString(output)),
        "didn't produce output"
      ))
    }

    matches(regexp, ...)(output)
  }
}

#' @export
#' @rdname matching-expectations
expect_error <- function(object, regexp = NULL, class = NULL, ..., info = NULL,
  label = NULL) {
  if (is.null(label)) {
    label <- find_expr("object")
  }
  expect_that(object, throws_error(regexp, ...), info = info, label = label)
}
#' @export
#' @rdname oldskool
throws_error <- function(regexp = NULL, class = NULL, ...) {
  function(expr) {
    res <- try(force(expr), TRUE)
    no_error <- !inherits(res, "try-error")
    if (no_error) {
      return(expectation(
        identical(regexp, NA),
        "code didn't raise an error",
        "code raised an error"
      ))
    }

    if (is.null(class)) {
      fails_error_subclass_check <- FALSE
      success_message <- "threw an error"
    } else {
      condition <- attr(res, "condition")
      fails_error_subclass_check <- !inherits(condition, class)
      success_message <- sprintf("threw an error (of type '%s')", class)
    }

    if (fails_error_subclass_check) {
      expectation(FALSE, sprintf("(error was not of expected type '%s')",
                                 class))
    } else if (!is.null(regexp)) {
      matches(regexp, ...)(res)
    } else {
      expectation(TRUE, "no error thrown", success_message)
    }
  }
}

#' @export
#' @rdname matching-expectations
expect_warning <- function(object, regexp = NULL, ..., all = FALSE, info = NULL,
  label = NULL) {
  if (is.null(label)) {
    label <- find_expr("object")
  }
  expect_that(object, gives_warning(regexp, ..., all = all), info = info, label = label)
}
#' @export
#' @rdname oldskool
gives_warning <- function(regexp = NULL, all = FALSE, ...) {
  function(expr) {
    warnings <- evaluate_promise(expr)$warnings

    if (identical(regexp, NA)) {
      expectation(
        length(warnings) == 0,
        paste0("expected no warnings:\n", paste("* ", warnings, collapse = "\n")),
        "no warnings"
      )
    } else if (!is.null(regexp) && length(warnings) > 0) {
      matches(regexp, all = all, ...)(warnings)
    } else {
      expectation(
        length(warnings) > 0,
        "no warnings given",
        paste0(length(warnings), " warnings created")
      )
    }
  }
}

#' @export
#' @rdname matching-expectations
expect_message <- function(object, regexp = NULL, ..., all = FALSE, info = NULL,
                           label = NULL) {
  if (is.null(label)) {
    label <- find_expr("object")
  }
  expect_that(object, shows_message(regexp, all = all, ...), info = info, label = label)
}
#' @export
#' @rdname oldskool
shows_message <- function(regexp = NULL, all = FALSE, ...) {
  function(expr) {
    messages <- evaluate_promise(expr)$messages

    if (identical(regexp, NA)) {
      expectation(
        length(messages) == 0,
        paste0("expected no message, got:\n", paste("* ", messages, collapse = "\n")),
        paste0("no messages")
      )
    } else if (!is.null(regexp) && length(messages) > 0) {
      matches(regexp, all = all, ...)(messages)
    } else {
      expectation(
        length(messages) > 0,
        "no messages shown",
        paste0(length(messages), " messages shown")
      )
    }
  }
}
